<!DOCTYPE html>
<html lang="en" >
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Esportive - Tournaments</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
    import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-analytics.js";

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyD...YOUR_API_KEY...",
      authDomain: "espotive.firebaseapp.com",
      projectId: "espotive",
      storageBucket: "espotive.appspot.com",
      messagingSenderId: "439864037476",
      appId: "1:439864037476:web:YOUR_APP_ID",
      measurementId: "G-YOUR_MEASUREMENT_ID"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const analytics = getAnalytics();

    // Google Sheets CSV link
    const googleSheetCSV = "https://docs.google.com/spreadsheets/d/14vc1xeZ...export?format=csv&gid=0";

    // SVG Icons consistent with your theme
    const detailsIcons = {
      "Event Name": `<svg xmlns="http://www.w3.org/2000/svg" class="inline w-4 h-4 mr-1 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4M7 12l5 5"/></svg>`,
      "Game": `<svg xmlns="http://www.w3.org/2000/svg" class="inline w-4 h-4 mr-1 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M12 4v16m8-8H4"/></svg>`,
      "PrizePool": `<svg xmlns="http://www.w3.org/2000/svg" class="inline w-4 h-4 mr-1 text-cyan-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><circle cx="12" cy="12" r="10"/></svg>`,
      "Slots": `<svg xmlns="http://www.w3.org/2000/svg" class="inline w-4 h-4 mr-1 text-purple-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><rect x="5" y="7" width="14" height="10" rx="2"/></svg>`,
      "Format": `<svg xmlns="http://www.w3.org/2000/svg" class="inline w-4 h-4 mr-1 text-blue-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M3 10h18M3 14h18"/></svg>`,
      "Close Date": `<svg xmlns="http://www.w3.org/2000/svg" class="inline w-4 h-4 mr-1 text-pink-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M8 7V3m8 4V3M3 11h18m-2 8H5a2 2 0 01-2-2v-6"/></svg>`,
      "Organization": `<svg xmlns="http://www.w3.org/2000/svg" class="inline w-4 h-4 mr-1 text-orange-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M3 7v3a4 4 0 004 4h10"/></svg>`,
      "Social Link": `<svg xmlns="http://www.w3.org/2000/svg" class="inline w-4 h-4 mr-1 text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path d="M16 8a6 6 0 00-9.33 4"/></svg>`
    };

    // Helper to create details rows with icons
    function createDetailRow(label, value, isLink=false) {
      return `
        <li class="flex items-center py-1 text-gray-300 select-text">
          ${detailsIcons[label]??''}
          <span class="font-semibold text-white mr-1">${label}:</span> 
          ${isLink ? `<a href="${value}" target="_blank" class="text-blue-400 underline">${value}</a>` : value}
        </li>
      `;
    }

    // Handles Firebase Auth UI and Logic
    function initAuthUI() {
      const profileContainer = document.getElementById('profile-container');
      const profileDropdown = document.getElementById('profile-dropdown');
      onAuthStateChanged(auth, user => {
        if (user) {
          if (user.photoURL) {
            profileContainer.innerHTML = `
              <img src="${user.photoURL}" alt="Profile Picture" class="rounded-full w-8 h-8 cursor-pointer" />
            `;
          } else {
            profileContainer.innerHTML = `
              <i class="fas fa-user-circle text-white text-2xl cursor-pointer"></i>
            `;
          }
          profileContainer.onclick = () => profileDropdown.classList.toggle('hidden');
        } else {
          window.location.href = '/';
        }
      });
      const logoutBtn = document.getElementById('logout-btn');
      if (logoutBtn) {
        logoutBtn.onclick = async () => {
          try {
            await signOut(auth);
            window.location.href = '/';
          } catch (err) {
            console.error('Logout error:', err);
          }
        };
      }
    }

    // Parse CSV function adapted for CSV from Sheets
    function parseCSV(csvText) {
      const lines = csvText.trim().split('\n');
      const headers = lines.shift().split(',').map(h => h.trim());

      const data = lines.map(line => {
        const values = line.split(',').map(v => v.trim());
        const obj = {};
        headers.forEach((h, i) => obj[h] = values[i]);
        return obj;
      }).filter(row => row['Event Name']); // basic validation

      return data;
    }

    // Render tournament cards
    function createTournamentCard(t) {
      const card = document.createElement('div');
      card.className = "tournament-card";

      card.innerHTML = `
        <div class="relative aspect-square w-full" style="min-height:145px;">
          <img src="${t.ImageURL}" alt="${t['Event Name']}" class="object-contain p-4 w-full h-full" />
          <div class="absolute inset-0 p-2 bg-black bg-opacity-90 text-white hidden rounded-lg details-panel">
            <ul>
              ${createDetailRow('Event Name', t['Event Name'])}
              ${createDetailRow('Game', t.Game)}
              ${createDetailRow('PrizePool', t.PrizePool)}
              ${createDetailRow('Slots', t.Slots)}
              ${createDetailRow('Format', t.Format)}
              ${createDetailRow('Close Date', t['Close Date'])}
              ${createDetailRow('Organization', t.Organization)}
              ${createDetailRow('Social Link', t['Social Link'], true)}
            </ul>
          </div>
        </div>
        <h2 class="text-lg font-bold text-center mt-2">${t['Event Name']}</h2>
        <p class="text-center text-gray-300 text-sm">${t.Game}</p>
        <p class="text-center text-gray-400 text-xs mb-2">Prize Pool: ${t.PrizePool}</p>
        <div class="flex justify-center gap-2">
          <button class="details-btn bg-red-600 rounded-full px-3 py-1 text-white font-semibold select-none">Details</button>
          <a href="${t.Registration}" target="_blank" class="bg-red-600 rounded-full px-3 py-1 text-white font-semibold select-none hover:bg-red-700">Register</a>
        </div>
      `;
      card.querySelector('.details-btn').onclick = () => {
        const panel = card.querySelector('.details-panel');
        panel.classList.toggle('hidden');
      };
      return card;
    }

    // Main application logic - fetch CSV, render tournaments, handle filter
    async function initTournaments() {
      const container = document.getElementById('tournaments-container');
      const filter = document.getElementById('game-filter');

      try {
        const res = await fetch(googleSheetCSV);
        const csvText = await res.text();
        let tournaments = parseCSV(csvText);

        // Populate filter with unique games
        const games = [...new Set(tournaments.map(t => t.Game))].sort();
        filter.innerHTML = `<option value="">All Games</option>` + games.map(g => `<option value="${g}">${g}</option>`).join('');

        // Filter and render function
        function render(filterVal='') {
          let filtered = filterVal ? tournaments.filter(t => t.Game === filterVal) : tournaments;
          container.innerHTML = '';
          if (filtered.length === 0) {
            container.innerHTML = `<p class="text-center text-gray-400">No tournaments found.</p>`;
            return;
          }
          filtered.slice(0, 20).forEach(t => container.appendChild(createTournamentCard(t)));
        }

        filter.onchange = () => render(filter.value);
        
        render();
      } catch (error) {
        container.innerHTML = `<p class="text-center text-red-600">Failed to load tournaments.</p>`;
        console.error('Error loading tournaments:', error);
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      initAuthUI();
      initTournaments();
    });

    function initAuthUI(){
      const profileContainer = document.getElementById('profile-container');
      const profileDropdown = document.getElementById('profile-dropdown');
      const auth = getAuth();
      onAuthStateChanged(auth, (user) => {
        if (user) {
          if (user.photoURL) {
            profileContainer.innerHTML = `<img src="${user.photoURL}" alt="Profile" class="w-8 h-8 rounded-full cursor-pointer border-2 border-red-600">`;
          } else {
            profileContainer.innerHTML = `<i class="fas fa-user-circle text-white text-2xl cursor-pointer"></i>`;
          }
          profileContainer.onclick = () => profileDropdown.classList.toggle('hidden');
        } else {
          window.location.href = '/';
        }
      });
      const logoutBtn = document.getElementById('logout-btn');
      if(logoutBtn){
        logoutBtn.onclick = async () => {
          try{
            await signOut(getAuth());
            window.location.href = '/';
          }catch(e){
            console.error(e);
          }
        };
      }
    }
  </script>
</body>
</html>
